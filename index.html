<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GD_FINAL_MULTISELECT</title>
    <style>
        :root { --neon: #00ff41; --bg: #050505; --panel: #111; --text: #eee; --gold: #ffd700; }
        body { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: var(--text); touch-action: none; }
        canvas { display: block; }

        /* –≠–ö–†–ê–ù–´ */
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #111 0%, #000 100%); z-index: 100; overflow-y: auto; padding: 20px 0; }
        .hidden { display: none !important; }
        
        .menu-card { background: var(--panel); padding: 30px; border: 1px solid #333; box-shadow: 0 0 30px rgba(0,255,65,0.1); text-align: center; border-radius: 4px; width: 500px; max-width: 95%; margin: 20px auto; }
        h1 { color: var(--neon); text-shadow: 0 0 10px var(--neon); letter-spacing: 4px; font-size: 24px; margin-bottom: 20px; }
        h2 { color: var(--neon); font-size: 18px; margin: 10px 0; }
        
        input, textarea { background: #000; border: 1px solid #333; color: var(--neon); padding: 12px; width: 100%; margin: 10px 0; box-sizing: border-box; outline: none; font-family: 'Courier New', monospace; }
        textarea { min-height: 80px; resize: vertical; }
        
        .btn { background: transparent; color: var(--neon); border: 1px solid var(--neon); padding: 12px; margin: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; box-sizing: border-box; }
        .btn:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
        .btn-red { color: #ff3e3e; border-color: #ff3e3e; }
        .btn-red:hover { background: #ff3e3e; box-shadow: 0 0 15px #ff3e3e; }
        .btn-gold { color: var(--gold); border-color: var(--gold); }
        .btn-small { padding: 8px; font-size: 10px; width: auto; margin: 2px; }
        .btn-play { background: #00ff41; color: #000; border: none; padding: 15px 30px; font-size: 18px; border-radius: 4px; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –ò–ì–†–´/–†–ï–î–ê–ö–¢–û–†–ê */
        #top-bar { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 10px; box-sizing: border-box; z-index: 60; background: rgba(0,0,0,0.8); }
        .level-tag { color: var(--neon); font-size: 12px; align-self: center; font-weight: bold; }

        #editor-ui { position: absolute; bottom: 0; left: 0; width: 100%; height: 200px; background: #000; border-top: 1px solid #333; display: flex; flex-direction: column; z-index: 50; }
        .tabs { display: flex; background: #0a0a0a; border-bottom: 1px solid #222; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; opacity: 0.4; font-size: 12px; font-weight: bold; }
        .tab.active { opacity: 1; color: var(--neon); border-bottom: 2px solid var(--neon); }
        
        .content-area { display: flex; overflow-x: auto; padding: 10px; gap: 8px; height: 100%; align-items: center; flex-wrap: wrap; align-content: flex-start; }
        .obj-btn { min-width: 55px; height: 55px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 9px; cursor: pointer; background: #111; flex-shrink: 0; }
        .multi-active { border: 2px solid #00ff41; }
        
        .list-container { margin-top: 15px; width: 100%; max-height: 300px; overflow-y: auto; }
        .level-item { background: #0d0d0d; padding: 12px; margin: 8px 0; border: 1px solid #222; text-align: left; position: relative; cursor: pointer; }
        .level-item:hover { border-color: var(--neon); }
        
        /* –†–ï–ô–¢–ò–ù–ì–ò */
        .rating-container { display: flex; align-items: center; gap: 5px; margin: 5px 0; }
        .difficulty-icon { width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; position: relative; }
        .featured-glow { box-shadow: 0 0 15px gold; border: 2px solid gold; }
        .epic-flame { box-shadow: 0 0 20px #ff8c00, 0 0 40px #ff8c00; border: 2px solid #ff8c00; }
        .legendary-flame { box-shadow: 0 0 20px #ff44aa, 0 0 40px #ff44aa; border: 2px solid #ff44aa; }
        .mythic-flame { box-shadow: 0 0 20px #44aaff, 0 0 40px #44aaff; border: 2px solid #44aaff; animation: mythicPulse 2s infinite; }
        @keyframes mythicPulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .stars-label { color: var(--gold); font-size: 10px; display: block; margin-top: 4px; font-weight: bold; }
        
        .admin-box { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444; display: flex; gap: 5px; flex-wrap: wrap; }

        .color-row { display: flex; align-items: center; justify-content: space-between; width: 250px; color: #ccc; font-size: 12px; margin: 10px; }
        input[type="color"] { padding: 0; width: 50px; height: 30px; border: none; background: none; cursor: pointer; }
        
        #progress-bar { position: absolute; top: 0; left: 0; height: 3px; background: var(--neon); width: 0%; z-index: 70; transition: 0.1s; }
        
        /* DEBUG INFO */
        #debug { position: absolute; bottom: 210px; left: 10px; font-size: 10px; color: #555; pointer-events: none; }

        /* –ü–†–û–§–ò–õ–¨ */
        .profile-stats { display: flex; justify-content: space-around; margin: 20px 0; }
        .stat-box { text-align: center; }
        .stat-value { font-size: 24px; color: var(--neon); }
        .stat-label { font-size: 12px; opacity: 0.7; }

        /* –ú–ï–ù–Æ –£–†–û–í–ù–Ø */
        .level-detail { text-align: left; }
        .level-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .level-title { font-size: 24px; color: var(--neon); }
        .level-id { font-size: 12px; opacity: 0.5; }
        .level-stats { display: flex; gap: 20px; margin: 15px 0; }
        .like-btn { background: transparent; border: 1px solid red; color: red; padding: 10px 20px; cursor: pointer; }
        .like-btn.active { background: red; color: #000; }
        .dislike-btn { background: transparent; border: 1px solid #ff3e3e; color: #ff3e3e; padding: 10px 20px; cursor: pointer; }

        /* –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò */
        .comments-section { margin-top: 20px; }
        .comment { background: #0a0a0a; padding: 10px; margin: 10px 0; border-left: 3px solid var(--neon); }
        .comment-author { color: var(--neon); font-weight: bold; }
        .comment-percent { color: var(--gold); font-size: 10px; margin-left: 10px; }
        .comment-text { margin: 5px 0; }
    </style>
</head>
<body>

<div id="progress-bar"></div>
<div id="debug"></div>

<!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
<div id="screen-auth" class="screen">
    <div class="menu-card">
        <h1>CONNECT_NET</h1>
        <input type="text" id="auth-nick" placeholder="NICKNAME">
        <button class="btn" onclick="window.authUser()">LOGIN</button>
    </div>
</div>

<!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
<div id="main-menu" class="screen hidden">
    <div class="menu-card">
        <h1 id="welcome-text">GD_PIZDEC</h1>
        <button class="btn" onclick="window.startNewLevel()">EDITOR</button>
        <button class="btn" onclick="window.showScreen('my-levels')">MY LEVELS</button>
        <button class="btn" onclick="window.showScreen('online-levels')">GLOBAL SERVER</button>
        <button class="btn" onclick="window.showScreen('profile')">PROFILE</button>
        <button class="btn btn-red" onclick="window.logout()">LOGOUT</button>
    </div>
</div>

<!-- –ú–û–ò –£–†–û–í–ù–ò (–õ–û–ö–ê–õ–¨–ù–´–ï) -->
<div id="my-levels" class="screen hidden">
    <div class="menu-card" style="width: 500px;">
        <h1>LOCAL_STORAGE</h1>
        <div id="levels-list" class="list-container"></div>
        <button class="btn btn-red" onclick="window.showScreen('main-menu')">BACK</button>
    </div>
</div>

<!-- –û–ù–õ–ê–ô–ù –£–†–û–í–ù–ò -->
<div id="online-levels" class="screen hidden">
    <div class="menu-card" style="width: 600px;">
        <h1>GLOBAL_NET</h1>
        <div id="online-list" class="list-container"></div>
        <button class="btn btn-red" onclick="window.showScreen('main-menu')">BACK</button>
    </div>
</div>

<!-- –ú–ï–ù–Æ –£–†–û–í–ù–Ø (–î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø) -->
<div id="level-menu" class="screen hidden">
    <div class="menu-card" style="width: 600px;">
        <div id="level-detail-container" class="level-detail"></div>
        <button class="btn btn-red" onclick="window.showScreen('online-levels')">BACK</button>
    </div>
</div>

<!-- –ü–†–û–§–ò–õ–¨ –ò–ì–†–û–ö–ê -->
<div id="profile" class="screen hidden">
    <div class="menu-card" style="width: 500px;">
        <h1 id="profile-name">PLAYER</h1>
        <div class="profile-stats">
            <div class="stat-box">
                <div class="stat-value" id="profile-stars">0</div>
                <div class="stat-label">STARS</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="profile-creator-points">0</div>
                <div class="stat-label">CREATOR POINTS</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="profile-downloads">0</div>
                <div class="stat-label">DOWNLOADS</div>
            </div>
        </div>
        <button class="btn" onclick="window.showScreen('main-menu')">BACK</button>
    </div>
</div>

<!-- –ò–ù–¢–ï–†–§–ï–ô–° –†–ï–î–ê–ö–¢–û–†–ê/–ò–ì–†–´ -->
<div id="top-bar" class="hidden">
    <button class="btn" style="width:auto" id="exit-btn" onclick="window.exitToMenu()">EXIT</button>
    <div id="level-info" class="level-tag">ID: 0000 | MODE: BUILD</div>
    <button class="btn" id="play-btn" style="width:auto" onclick="window.togglePlaytest()">PLAY</button>
</div>

<div id="editor-ui" class="hidden">
    <div class="tabs">
        <div id="tab-build" class="tab active" onclick="window.switchTab('build')">BUILD</div>
        <div id="tab-edit" class="tab" onclick="window.switchTab('edit')">EDIT</div>
        <div id="tab-color" class="tab" onclick="window.switchTab('color')">COLOR</div>
    </div>
    
    <div id="panel-build" class="content-area">
        <div class="obj-btn" style="color:#888" onclick="window.selectedType='block'">BLOCK</div>
        <div class="obj-btn" style="color:#888" onclick="window.selectedType='halfblock'">HALF</div>
        <div class="obj-btn" style="color:#ff69b4" onclick="window.selectedType='rainbow'">üåà</div>
        <div class="obj-btn" style="color:#aaa" onclick="window.selectedType='slope'">SLOPE</div>
        <div class="obj-btn" style="color:#eee" onclick="window.selectedType='spike'">SPIKE</div>
        <div class="obj-btn" style="color:cyan" onclick="window.selectedType='start'">START</div>
        <div class="obj-btn" style="color:#00ff41" onclick="window.selectedType='end'">FINISH</div>
        <div class="obj-btn" style="color:yellow" onclick="window.selectedType='orb'">ORB</div>
        <div class="obj-btn" style="color:#ff69b4" onclick="window.selectedType='orb_pink'">PINK</div>
        <div class="obj-btn" style="color:#ff3333" onclick="window.selectedType='orb_red'">RED</div>
        <div class="obj-btn" style="color:#222; background:#ccc" onclick="window.selectedType='orb_black'">BLACK</div>
        <div class="obj-btn" style="color:magenta" onclick="window.selectedType='pad'">PAD</div>
        <div class="obj-btn" style="color:#ff69b4" onclick="window.selectedType='pad_pink'">PINK</div>
        <div class="obj-btn" style="color:#ff3333" onclick="window.selectedType='pad_red'">RED</div>
        <div class="obj-btn" style="color:#00a8ff" onclick="window.selectedType='portal_wave'">WAVE</div>
        <div class="obj-btn" style="color:#00ff00" onclick="window.selectedType='portal_cube'">CUBE</div>
        <div class="obj-btn" style="color:#ff69b4" onclick="window.selectedType='portal_ship'">SHIP</div>
        <div class="obj-btn" style="color:#aa00ff" onclick="window.selectedType='portal_spider'">SPIDER</div>
        <div class="obj-btn" style="color:#ffff00" onclick="window.selectedType='glow'">GLOW</div>
    </div>
    
    <div id="panel-edit" class="content-area hidden">
        <button class="btn btn-small" onclick="window.cameraX -= 150"> CAM << </button>
        <button class="btn btn-small" onclick="window.cameraX += 150"> CAM >> </button>
        <button class="btn btn-small" onclick="window.toggleMultiSelect()" id="multi-btn">MULTI</button>
        <button class="btn btn-small" onclick="window.selectAll()">ALL</button>
        <button class="btn btn-small" onclick="window.deselectAll()">NONE</button>
        <button class="btn btn-small" onclick="window.moveObj(0,-10)">UP</button>
        <button class="btn btn-small" onclick="window.moveObj(0,10)">DN</button>
        <button class="btn btn-small" onclick="window.moveObj(-10,0)">LEFT</button>
        <button class="btn btn-small" onclick="window.moveObj(10,0)">RIGHT</button>
        <button class="btn btn-small" onclick="window.scaleObj(0.2)">SIZE+</button>
        <button class="btn btn-small" onclick="window.scaleObj(-0.2)">SIZE-</button>
        <button class="btn btn-small" onclick="window.rotateObj()">ROT</button>
        <button class="btn btn-small" onclick="window.copyObj()">COPY</button>
        <button class="btn btn-small" onclick="window.pasteObj()">PASTE</button>
        <button class="btn btn-small btn-red" onclick="window.deleteObj()">DEL</button>
    </div>

    <div id="panel-color" class="content-area hidden" style="flex-direction: column;">
        <div class="color-row">
            <span>OBJ COLOR:</span>
            <input type="color" id="color-obj" onchange="window.setObjColor(this.value)">
        </div>
        <div class="color-row">
            <span>BG COLOR:</span>
            <input type="color" id="color-bg" onchange="window.setBgColor(this.value)" value="#050505">
        </div>
        <div class="color-row">
            <span>GROUND COLOR:</span>
            <input type="color" id="color-ground" onchange="window.setGroundColor(this.value)" value="#001a00">
        </div>
    </div>
</div>

<canvas id="g"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove, update as dbUpdate } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB2cAHCuBmB7rr0S9YFmAQ3fK9lvUm-8AQ",
        authDomain: "dfssdfgg-df720.firebaseapp.com",
        projectId: "dfssdfgg-df720",
        storageBucket: "dfssdfgg-df720.firebasestorage.app",
        messagingSenderId: "751965793703",
        appId: "1:751965793703:web:9dcfbf89ca9997b757da82",
        databaseURL: "https://dfssdfgg-df720-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
    window.user = { nick: "", isAdmin: false };
    window.gameState = 'AUTH';
    window.currentTab = 'build';
    window.selectedType = 'block';
    window.selectedInstance = null;           // –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    window.selectedInstances = [];             // –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    window.multiSelectMode = false;            // —Ä–µ–∂–∏–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    window.clipboard = [];                      // –∫–æ–ø–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
    window.levelData = [];
    window.levelBgColor = '#050505';
    window.levelGroundColor = '#001a00';
    window.cameraX = 0;
    window.curName = "Project";
    window.curId = 0;
    window.particles = [];
    window.currentLevelId = null;

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
    window.playerStats = {
        stars: 0,
        creatorPoints: 0,
        downloads: 0
    };

    const cvs = document.getElementById('g');
    const ctx = cvs.getContext('2d');

    const logicalFloorY = 520; 
    const bs = 40; 
    
    // ========== –§–ò–ó–ò–ö–ê ==========
    const speedFactor = 1.8;
    const speed = 3.0 * speedFactor;
    const jumpForce = -11.0;
    const gravity = 0.6;
    const waveSpeed = 4.5 * speedFactor;
    const shipGravity = 0.12 * speedFactor;
    const shipLift = -0.25 * speedFactor;

    const orbPinkFactor = 0.8;
    const orbRedFactor = 1.5;
    const padFactor = 1.6;
    const padPinkFactor = 1.3;
    const padRedFactor = 2.0;

    let player = { 
        x: 100, 
        y: logicalFloorY - bs, 
        w: bs, 
        h: bs, 
        dy: 0, 
        onG: false, 
        mode: 'cube', 
        dead: false, 
        rotation: 0,
        gravityMultiplier: 1
    };
    let isPressing = false;
    let lastTimestamp = 0;

    window.addEventListener('resize', () => { cvs.width = window.innerWidth; cvs.height = window.innerHeight; });
    window.dispatchEvent(new Event('resize'));

    // --- –°–ò–°–¢–ï–ú–ê –ê–ö–ö–ê–£–ù–¢–û–í ---
    window.authUser = function() {
        const nick = document.getElementById('auth-nick').value.trim();
        if(!nick) return alert("ENTER NAME");
        window.user.nick = nick;
        window.user.isAdmin = (nick === "dxmtm" || nick === "admin");
        document.getElementById('welcome-text').innerText = "PLAYER: " + nick;
        window.gameState = 'MENU';
        loadPlayerStats();
        window.showScreen('main-menu');
    };

    window.logout = function() {
        window.user = { nick: "", isAdmin: false };
        window.gameState = 'AUTH';
        window.showScreen('screen-auth');
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞ –∏–∑ Firebase
    async function loadPlayerStats() {
        if (!window.user.nick) return;
        try {
            const snap = await get(child(ref(db), 'players/' + window.user.nick));
            if (snap.exists()) {
                window.playerStats = snap.val();
            } else {
                window.playerStats = { stars: 0, creatorPoints: 0, downloads: 0 };
                await set(ref(db, 'players/' + window.user.nick), window.playerStats);
            }
            updateProfileDisplay();
        } catch(e) { console.error("Stats error", e); }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    function updateProfileDisplay() {
        document.getElementById('profile-name').innerText = window.user.nick;
        document.getElementById('profile-stars').innerText = window.playerStats.stars || 0;
        document.getElementById('profile-creator-points').innerText = window.playerStats.creatorPoints || 0;
        document.getElementById('profile-downloads').innerText = window.playerStats.downloads || 0;
    }

    // --- FIREBASE –§–£–ù–ö–¶–ò–ò ---
    window.publishLevel = async function(id) {
        let levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        let lvl = levels.find(l => l.id === id);
        if (lvl) {
            lvl.author = window.user.nick;
            lvl.stars = 0;
            lvl.ratingType = 'none';
            lvl.likes = 0;
            lvl.dislikes = 0;
            lvl.downloads = 0;
            lvl.comments = [];
            try {
                await set(ref(db, 'public_levels/' + id), lvl);
                alert("PUBLISHED!");
                window.renderLevelsList();
            } catch(e) { alert("DB ERROR!"); }
        }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–Ω–ª–∞–π–Ω —É—Ä–æ–≤–Ω–µ–π —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
    window.loadOnlineLevels = async function() {
        const list = document.getElementById('online-list');
        list.innerHTML = "SYNC...";
        try {
            const snap = await get(child(ref(db), 'public_levels'));
            if (snap.exists()) {
                const data = snap.val();
                list.innerHTML = Object.values(data).map(l => {
                    let ratingClass = '';
                    if (l.ratingType === 'featured') ratingClass = 'featured-glow';
                    else if (l.ratingType === 'epic') ratingClass = 'epic-flame';
                    else if (l.ratingType === 'legendary') ratingClass = 'legendary-flame';
                    else if (l.ratingType === 'mythic') ratingClass = 'mythic-flame';
                    
                    return `
                    <div class="level-item" onclick="window.openLevelMenu(${l.id})">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="difficulty-icon ${ratingClass}" style="background: #333;">
                                ${l.stars || '?'}
                            </div>
                            <div style="flex-grow: 1;">
                                <div><b style="color:var(--neon)">${l.name}</b> <span style="font-size:9px;">by ${l.author}</span></div>
                                <div class="rating-container">
                                    <span style="color:red;">‚ô° ${l.likes || 0}</span>
                                    <span style="color:#ff3e3e;">üíî ${l.dislikes || 0}</span>
                                    <span>-> ${l.downloads || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            } else { list.innerText = "EMPTY"; }
        } catch(e) { list.innerText = "NET ERROR"; }
    };

    // –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —É—Ä–æ–≤–Ω—è
    window.openLevelMenu = async function(id) {
        window.currentLevelId = id;
        const snap = await get(child(ref(db), 'public_levels/' + id));
        if (snap.exists()) {
            const lvl = snap.val();
            displayLevelMenu(lvl);
            window.showScreen('level-menu');
        }
    };

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω—é —É—Ä–æ–≤–Ω—è
    function displayLevelMenu(lvl) {
        let ratingClass = '';
        let ratingName = 'Unrated';
        if (lvl.ratingType === 'featured') { ratingClass = 'featured-glow'; ratingName = 'FEATURED'; }
        else if (lvl.ratingType === 'epic') { ratingClass = 'epic-flame'; ratingName = 'EPIC'; }
        else if (lvl.ratingType === 'legendary') { ratingClass = 'legendary-flame'; ratingName = 'LEGENDARY'; }
        else if (lvl.ratingType === 'mythic') { ratingClass = 'mythic-flame'; ratingName = 'MYTHIC'; }

        let html = `
            <div class="level-header">
                <div class="difficulty-icon ${ratingClass}" style="width:60px; height:60px; background:#333;">
                    ${lvl.stars || '?'}
                </div>
                <div>
                    <div class="level-title">${lvl.name}</div>
                    <div class="level-id">ID: ${lvl.id}</div>
                    <div>by ${lvl.author}</div>
                    <div style="color:${ratingClass ? '#ffd700' : '#888'}">${ratingName}</div>
                </div>
            </div>
            <div class="level-stats">
                <button class="like-btn" onclick="window.likeLevel(${lvl.id})">‚ô° LIKE (${lvl.likes || 0})</button>
                <button class="dislike-btn" onclick="window.dislikeLevel(${lvl.id})">üíî DISLIKE (${lvl.dislikes || 0})</button>
            </div>
            <button class="btn-play" onclick="window.playGlobalLevel('${btoa(JSON.stringify(lvl))}')">‚ñ∂ PLAY</button>
            <div style="margin:20px 0;">
                <h2>COMMENTS</h2>
                <textarea id="new-comment" placeholder="Write comment..."></textarea>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="comment-percent" placeholder="Progress %" min="0" max="100">
                    <button class="btn" onclick="window.addComment(${lvl.id})">POST</button>
                </div>
                <div id="comments-list" class="comments-section">
                    ${(lvl.comments || []).map(c => `
                        <div class="comment">
                            <span class="comment-author">${c.author}</span>
                            ${c.percent ? `<span class="comment-percent">${c.percent}%</span>` : ''}
                            <div class="comment-text">${c.text}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        if (window.user.isAdmin) {
            html += `
                <div class="admin-box">
                    <button class="btn btn-small" onclick="window.adminRateLevel(${lvl.id}, 'featured')">FEATURE</button>
                    <button class="btn btn-small btn-gold" onclick="window.adminRateLevel(${lvl.id}, 'epic')">EPIC</button>
                    <button class="btn btn-small" style="color:#ff44aa" onclick="window.adminRateLevel(${lvl.id}, 'legendary')">LEGENDARY</button>
                    <button class="btn btn-small" style="color:#44aaff" onclick="window.adminRateLevel(${lvl.id}, 'mythic')">MYTHIC</button>
                </div>
            `;
        }
        document.getElementById('level-detail-container').innerHTML = html;
    }

    // –õ–∞–π–∫ —É—Ä–æ–≤–Ω—è
    window.likeLevel = async function(id) {
        const snap = await get(child(ref(db), 'public_levels/' + id));
        if (snap.exists()) {
            let lvl = snap.val();
            lvl.likes = (lvl.likes || 0) + 1;
            await dbUpdate(ref(db, 'public_levels/' + id), { likes: lvl.likes });
            window.openLevelMenu(id);
        }
    };

    // –î–∏–∑–ª–∞–π–∫
    window.dislikeLevel = async function(id) {
        const snap = await get(child(ref(db), 'public_levels/' + id));
        if (snap.exists()) {
            let lvl = snap.val();
            lvl.dislikes = (lvl.dislikes || 0) + 1;
            await dbUpdate(ref(db, 'public_levels/' + id), { dislikes: lvl.dislikes });
            window.openLevelMenu(id);
        }
    };

    // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    window.addComment = async function(id) {
        const text = document.getElementById('new-comment').value.trim();
        const percent = document.getElementById('comment-percent').value;
        if (!text) return alert("Enter comment");
        
        const snap = await get(child(ref(db), 'public_levels/' + id));
        if (snap.exists()) {
            let lvl = snap.val();
            if (!lvl.comments) lvl.comments = [];
            lvl.comments.push({
                author: window.user.nick,
                text: text,
                percent: percent || null,
                timestamp: Date.now()
            });
            await dbUpdate(ref(db, 'public_levels/' + id), { comments: lvl.comments });
            document.getElementById('new-comment').value = '';
            document.getElementById('comment-percent').value = '';
            window.openLevelMenu(id);
        }
    };

    // –ê–¥–º–∏–Ω—Å–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —É—Ä–æ–≤–Ω—è
    window.adminRateLevel = async function(id, type) {
        const stars = prompt("STARS (1-10):");
        if (!stars) return;
        
        let cp = 0;
        if (type === 'featured') cp = 2;
        else if (type === 'epic') cp = 3;
        else if (type === 'legendary') cp = 4;
        else if (type === 'mythic') cp = 5;
        
        await dbUpdate(ref(db, 'public_levels/' + id), { 
            stars: parseInt(stars), 
            ratingType: type,
            creatorPoints: cp
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º CP –∞–≤—Ç–æ—Ä—É
        const snap = await get(child(ref(db), 'public_levels/' + id));
        if (snap.exists()) {
            const lvl = snap.val();
            const authorSnap = await get(child(ref(db), 'players/' + lvl.author));
            if (authorSnap.exists()) {
                let authorStats = authorSnap.val();
                authorStats.creatorPoints = (authorStats.creatorPoints || 0) + cp;
                await set(ref(db, 'players/' + lvl.author), authorStats);
            }
        }
        window.openLevelMenu(id);
        window.loadOnlineLevels();
    };

    // –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
    window.deleteLocalLevel = function(id) {
        if (!confirm("DELETE LEVEL?")) return;
        let levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        levels = levels.filter(l => l.id !== id);
        localStorage.setItem('gd_v3', JSON.stringify(levels));
        window.renderLevelsList();
    };

    // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    window.showScreen = function(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        if(id !== 'none') document.getElementById(id).classList.remove('hidden');
        if(id === 'my-levels') window.renderLevelsList();
        if(id === 'online-levels') window.loadOnlineLevels();
        if(id === 'profile') updateProfileDisplay();
    };

    window.startNewLevel = function() {
        window.levelData = []; 
        window.levelBgColor = '#050505';
        window.levelGroundColor = '#001a00';
        document.getElementById('color-bg').value = '#050505';
        document.getElementById('color-ground').value = '#001a00';
        window.curName = prompt("NAME:") || "NONAME";
        window.curId = Math.floor(Math.random() * 99999);
        window.gameState = 'EDITOR'; 
        window.toggleUI(true);
    };

    window.toggleUI = function(show) {
        document.getElementById('editor-ui').classList.toggle('hidden', !show);
        document.getElementById('top-bar').classList.toggle('hidden', !show);
        document.getElementById('main-menu').classList.toggle('hidden', show);
        document.getElementById('level-info').innerText = `ID: ${window.curId} | ${window.curName}`;
        document.getElementById('exit-btn').innerText = show ? "SAVE & EXIT" : "EXIT";
    };

    window.switchTab = function(t) {
        window.currentTab = t;
        ['build', 'edit', 'color'].forEach(x => {
            document.getElementById('tab-' + x).classList.toggle('active', t === x);
            document.getElementById('panel-' + x).classList.toggle('hidden', t !== x);
        });
        if(t === 'color' && window.selectedInstance) {
            document.getElementById('color-obj').value = window.selectedInstance.color || '#ffffff';
        }
    };

    window.setObjColor = function(c) { 
        if (window.multiSelectMode && window.selectedInstances.length) {
            window.selectedInstances.forEach(obj => obj.color = c);
        } else if (window.selectedInstance) {
            window.selectedInstance.color = c;
        }
    };
    window.setBgColor = function(c) { window.levelBgColor = c; };
    window.setGroundColor = function(c) { window.levelGroundColor = c; };

    // --- –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–û–ï –í–´–î–ï–õ–ï–ù–ò–ï ---
    window.toggleMultiSelect = function() {
        window.multiSelectMode = !window.multiSelectMode;
        document.getElementById('multi-btn').style.border = window.multiSelectMode ? '2px solid #00ff41' : '';
        if (!window.multiSelectMode) {
            window.selectedInstances = [];
        }
    };

    window.selectAll = function() {
        window.selectedInstances = [...window.levelData];
        window.multiSelectMode = true;
        document.getElementById('multi-btn').style.border = '2px solid #00ff41';
    };

    window.deselectAll = function() {
        window.selectedInstances = [];
        window.selectedInstance = null;
    };

    // --- –Ø–î–†–û –ò–ì–†–´ ---
    window.playGlobalLevel = function(b64) {
        const lvl = JSON.parse(atob(b64));
        window.levelData = lvl.data || [];
        window.levelBgColor = lvl.bgColor || '#050505';
        window.levelGroundColor = lvl.groundColor || '#001a00';
        window.curId = lvl.id; 
        window.curName = lvl.name;
        window.gameState = 'ONLINE_PLAY';
        window.showScreen('none');
        document.getElementById('top-bar').classList.remove('hidden');
        document.getElementById('editor-ui').classList.add('hidden');
        document.getElementById('play-btn').innerText = "PAUSE";
        document.getElementById('level-info').innerText = `${window.curName} by ${lvl.author}`;
        
        dbUpdate(ref(db, 'public_levels/' + lvl.id), { downloads: (lvl.downloads || 0) + 1 });
        
        resetPlayer();
    };

    window.togglePlaytest = function() {
        if (window.gameState === 'EDITOR') {
            window.gameState = 'PLAYTEST'; 
            resetPlayer();
            document.getElementById('play-btn').innerText = 'STOP';
        } else if (window.gameState === 'PLAYTEST') {
            window.gameState = 'EDITOR';
            document.getElementById('play-btn').innerText = 'PLAY';
        } else if (window.gameState === 'ONLINE_PLAY') {
            if(confirm("EXIT LEVEL?")) window.exitToMenu();
        }
    };

    function resetPlayer() {
        const start = window.levelData.find(o => o.type === 'start');
        player.x = start ? start.x : 100;
        player.y = start ? start.y : logicalFloorY - bs;
        player.dy = 0; 
        player.mode = 'cube';
        player.w = bs; player.h = bs;
        player.dead = false;
        player.onG = false;
        player.rotation = 0;
        player.gravityMultiplier = 1;
        window.cameraX = player.x - 100;
    }

    function die() {
        if(player.dead) return;
        player.dead = true;
        for(let i=0; i<15; i++) {
            window.particles.push({
                x: player.x + player.w/2, y: player.y + player.h/2,
                dx: (Math.random()-0.5)*10, dy: (Math.random()-0.5)*10,
                life: 1.0, c: player.mode === 'wave' ? '#00a8ff' : (player.mode === 'ship' ? '#ff69b4' : (player.mode === 'spider' ? '#aa00ff' : '#00ff41'))
            });
        }
        setTimeout(resetPlayer, 600);
    }

    window.exitToMenu = function() {
        if(window.gameState === 'EDITOR' || window.gameState === 'PLAYTEST') {
            window.saveLocal();
        }
        document.getElementById('editor-ui').classList.add('hidden');
        document.getElementById('top-bar').classList.add('hidden');
        window.gameState = 'MENU';
        window.showScreen('main-menu');
    };

    window.saveLocal = function() {
        let levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        levels = levels.filter(l => l.id !== window.curId);
        levels.push({ 
            id: window.curId, 
            name: window.curName, 
            data: window.levelData, 
            author: window.user.nick, 
            bgColor: window.levelBgColor,
            groundColor: window.levelGroundColor
        });
        localStorage.setItem('gd_v3', JSON.stringify(levels));
    };

    window.renderLevelsList = function() {
        const levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        document.getElementById('levels-list').innerHTML = levels.map(l => `
            <div class="level-item">
                <span>#${l.id} <b>${l.name}</b></span>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn" style="width:auto; padding:5px" onclick="window.loadLocalLevel(${l.id})">EDIT</button>
                    <button class="btn" style="width:auto; padding:5px; color:cyan" onclick="window.publishLevel(${l.id})">PUB</button>
                    <button class="btn btn-red" style="width:auto; padding:5px" onclick="window.deleteLocalLevel(${l.id})">DEL</button>
                </div>
            </div>
        `).join('');
    };

    window.loadLocalLevel = function(id) {
        const lvl = JSON.parse(localStorage.getItem('gd_v3')).find(l => l.id === id);
        window.levelData = lvl.data || [];
        window.levelBgColor = lvl.bgColor || '#050505';
        window.levelGroundColor = lvl.groundColor || '#001a00';
        document.getElementById('color-bg').value = window.levelBgColor;
        document.getElementById('color-ground').value = window.levelGroundColor;
        window.curId = lvl.id; 
        window.curName = lvl.name;
        window.gameState = 'EDITOR'; 
        window.toggleUI(true); 
        window.showScreen('none');
    };

    // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï
    function getScreenCamY() { return (cvs.height * 0.7) - logicalFloorY; }

    cvs.addEventListener('mousedown', e => {
        if (window.gameState !== 'EDITOR' || e.clientY > cvs.height - 200) return;
        const x = e.clientX + window.cameraX;
        const y = e.clientY - getScreenCamY();
        
        if (window.currentTab === 'build') {
            let newObj = { 
                x: Math.floor(x/bs)*bs, 
                y: Math.floor(y/bs)*bs, 
                type: window.selectedType, 
                rot: 0, 
                scale: 1,
                color: (window.selectedType === 'glow') ? '#ffff00' : undefined
            };
            window.levelData.push(newObj);
        } else if (window.currentTab === 'edit' || window.currentTab === 'color') {
            const clickedObj = window.levelData.find(o => 
                x > o.x && x < o.x + (bs*(o.scale||1)) && 
                y > o.y && y < o.y + (bs*(o.scale||1))
            );
            
            if (e.ctrlKey || window.multiSelectMode) {
                // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                if (clickedObj) {
                    const index = window.selectedInstances.indexOf(clickedObj);
                    if (index === -1) {
                        window.selectedInstances.push(clickedObj);
                    } else {
                        window.selectedInstances.splice(index, 1);
                    }
                }
            } else {
                // –û–¥–∏–Ω–æ—á–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                window.selectedInstances = [];
                window.selectedInstance = clickedObj || null;
                if (window.selectedInstance && window.currentTab === 'color') {
                    document.getElementById('color-obj').value = window.selectedInstance.color || '#ffffff';
                }
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
    function forEachSelected(callback) {
        if (window.multiSelectMode && window.selectedInstances.length) {
            window.selectedInstances.forEach(callback);
        } else if (window.selectedInstance) {
            callback(window.selectedInstance);
        }
    }

    window.moveObj = (dx, dy) => {
        forEachSelected(obj => { obj.x += dx; obj.y += dy; });
    };
    window.scaleObj = (ds) => {
        forEachSelected(obj => { obj.scale = Math.max(0.1, (obj.scale || 1) + ds); });
    };
    window.rotateObj = () => {
        forEachSelected(obj => { obj.rot = ((obj.rot || 0) + 90) % 360; });
    };
    window.deleteObj = () => {
        if (window.multiSelectMode && window.selectedInstances.length) {
            window.levelData = window.levelData.filter(obj => !window.selectedInstances.includes(obj));
            window.selectedInstances = [];
        } else if (window.selectedInstance) {
            window.levelData = window.levelData.filter(obj => obj !== window.selectedInstance);
            window.selectedInstance = null;
        }
    };
    window.copyObj = () => {
        if (window.multiSelectMode && window.selectedInstances.length) {
            window.clipboard = window.selectedInstances.map(obj => JSON.parse(JSON.stringify(obj)));
        } else if (window.selectedInstance) {
            window.clipboard = [JSON.parse(JSON.stringify(window.selectedInstance))];
        }
    };
    window.pasteObj = () => {
        if (window.clipboard && window.clipboard.length) {
            let newObjs = window.clipboard.map(obj => {
                let newObj = JSON.parse(JSON.stringify(obj));
                newObj.x += 40;
                return newObj;
            });
            window.levelData.push(...newObjs);
            if (window.multiSelectMode) {
                window.selectedInstances = newObjs;
            } else {
                window.selectedInstance = newObjs[0];
            }
        }
    };

    // –¶–ò–ö–õ –û–¢–†–ò–°–û–í–ö–ò
    function draw(now) {
        if (!lastTimestamp) lastTimestamp = now;
        let dt = Math.min((now - lastTimestamp) / 1000, 0.03);
        lastTimestamp = now;

        ctx.fillStyle = window.levelBgColor; 
        ctx.fillRect(0, 0, cvs.width, cvs.height);
        
        ctx.save(); 
        const camYOffset = getScreenCamY();
        ctx.translate(-window.cameraX, camYOffset);

        if(window.gameState === 'EDITOR') {
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            for (let i = 0; i < cvs.width + bs; i += bs) {
                ctx.beginPath(); 
                ctx.moveTo(i + window.cameraX - (window.cameraX % bs), -camYOffset); 
                ctx.lineTo(i + window.cameraX - (window.cameraX % bs), cvs.height - camYOffset); 
                ctx.stroke();
            }
        }

        ctx.fillStyle = window.levelGroundColor; 
        ctx.fillRect(window.cameraX, logicalFloorY, cvs.width, 1000);
        ctx.strokeStyle = "white"; 
        ctx.lineWidth = 3;
        ctx.beginPath(); 
        ctx.moveTo(window.cameraX, logicalFloorY); 
        ctx.lineTo(window.cameraX + cvs.width, logicalFloorY); 
        ctx.stroke();

        window.levelData.forEach(o => {
            let s = o.scale || 1;
            ctx.save(); 
            ctx.translate(o.x + (bs*s)/2, o.y + (bs*s)/2); 
            ctx.rotate((o.rot||0) * Math.PI / 180);
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            if ((window.multiSelectMode && window.selectedInstances.includes(o)) || o === window.selectedInstance) {
                ctx.strokeStyle = "#00ff41"; 
                ctx.lineWidth = 3; 
                ctx.strokeRect(-(bs*s)/2, -(bs*s)/2, bs*s, bs*s);
            }

            let defaultColor;
            switch (o.type) {
                case 'block': defaultColor = "#888"; break;
                case 'halfblock': defaultColor = "#888"; break;
                case 'slope': defaultColor = "#aaa"; break;
                case 'spike': defaultColor = "#eee"; break;
                case 'start': defaultColor = "cyan"; break;
                case 'end': defaultColor = "#00ff41"; break;
                case 'orb': defaultColor = "yellow"; break;
                case 'orb_pink': defaultColor = "#ff69b4"; break;
                case 'orb_red': defaultColor = "#ff3333"; break;
                case 'orb_black': defaultColor = "#222222"; break;
                case 'pad': defaultColor = "magenta"; break;
                case 'pad_pink': defaultColor = "#ff69b4"; break;
                case 'pad_red': defaultColor = "#ff3333"; break;
                case 'portal_wave': defaultColor = "#00a8ff"; break;
                case 'portal_cube': defaultColor = "#00ff00"; break;
                case 'portal_ship': defaultColor = "#ff69b4"; break;
                case 'portal_spider': defaultColor = "#aa00ff"; break;
                case 'glow': defaultColor = "#ffff00"; break;
                default: defaultColor = "#888";
            }

            if (o.type === 'rainbow') {
                let hue = (Date.now() / 20) % 360;
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            } else {
                ctx.fillStyle = o.color || defaultColor;
            }

            if (o.type === 'spike') {
                ctx.beginPath(); 
                ctx.moveTo(-(bs*s)/2, (bs*s)/2); 
                ctx.lineTo(0, -(bs*s)/2); 
                ctx.lineTo((bs*s)/2, (bs*s)/2); 
                ctx.fill();
            } else if (o.type === 'slope') {
                ctx.beginPath(); 
                ctx.moveTo(-(bs*s)/2, (bs*s)/2); 
                ctx.lineTo((bs*s)/2, (bs*s)/2); 
                ctx.lineTo((bs*s)/2, -(bs*s)/2); 
                ctx.fill();
            } else if (o.type === 'halfblock') {
                ctx.fillRect(-(bs*s)/2, 0, bs*s, (bs*s)/2);
            } else if (o.type === 'start') {
                ctx.strokeStyle = ctx.fillStyle; 
                ctx.strokeRect(-(bs*s)/2, -(bs*s)/2, bs*s, bs*s);
            } else if (o.type === 'end') {
                ctx.fillRect(-(bs*s)/2, -(bs*s)/2, bs*s, bs*s);
            } else if (o.type.includes('orb')) {
                ctx.strokeStyle = ctx.fillStyle; 
                ctx.beginPath(); 
                ctx.arc(0, 0, 15*s, 0, Math.PI*2); 
                ctx.stroke();
            } else if (o.type.includes('pad')) {
                ctx.fillRect(-(bs*s)/2, (bs*s)/4, bs*s, (bs*s)/4);
            } else if (o.type === 'portal_wave') {
                ctx.strokeStyle = ctx.fillStyle; 
                ctx.lineWidth = 3; 
                ctx.beginPath(); 
                ctx.moveTo(-(bs*s)/2, (bs*s)); 
                ctx.lineTo(0, -(bs*s)); 
                ctx.lineTo((bs*s)/2, (bs*s)); 
                ctx.stroke();
            } else if (o.type === 'portal_cube') {
                ctx.strokeStyle = ctx.fillStyle; 
                ctx.lineWidth = 3; 
                ctx.strokeRect(-(bs*s)/2, -(bs*s), bs*s, bs*s*2);
            } else if (o.type === 'portal_ship') {
                ctx.strokeStyle = ctx.fillStyle; 
                ctx.lineWidth = 3; 
                ctx.beginPath(); 
                ctx.moveTo(-(bs*s)/2, -(bs*s)); 
                ctx.lineTo((bs*s)/2, 0); 
                ctx.lineTo(-(bs*s)/2, (bs*s)); 
                ctx.stroke();
            } else if (o.type === 'portal_spider') {
                ctx.strokeStyle = ctx.fillStyle; 
                ctx.lineWidth = 3; 
                ctx.beginPath(); 
                ctx.moveTo(-(bs*s)/2, -(bs*s)/2); 
                ctx.lineTo((bs*s)/2, (bs*s)/2); 
                ctx.moveTo((bs*s)/2, -(bs*s)/2); 
                ctx.lineTo(-(bs*s)/2, (bs*s)/2); 
                ctx.stroke();
            } else if (o.type === 'glow') {
                ctx.globalAlpha = 0.6; 
                ctx.beginPath(); 
                ctx.arc(0, 0, 15*s, 0, Math.PI*2); 
                ctx.fill(); 
                ctx.globalAlpha = 1.0;
            } else {
                ctx.fillRect(-(bs*s)/2, -(bs*s)/2, bs*s, bs*s);
                ctx.strokeStyle = "#111"; 
                ctx.strokeRect(-(bs*s)/2, -(bs*s)/2, bs*s, bs*s);
            }
            ctx.restore();
        });

        if (!player.dead && (window.gameState.includes('PLAY') || window.gameState === 'EDITOR' || window.gameState === 'ONLINE_PLAY')) {
            ctx.save();
            ctx.translate(player.x + player.w/2, player.y + player.h/2);
            
            if (player.mode === 'ship') {
                let rot = player.dy * 2;
                rot = Math.max(-30, Math.min(30, rot));
                ctx.rotate(rot * Math.PI / 180);
            }
            
            ctx.fillStyle = player.mode === 'wave' ? "#00a8ff" : (player.mode === 'ship' ? "#ff69b4" : (player.mode === 'spider' ? "#aa00ff" : "#00ff41"));
            ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
            ctx.strokeStyle = "white"; 
            ctx.strokeRect(-player.w/2, -player.h/2, player.w, player.h);
            
            if (player.mode === 'spider') {
                ctx.beginPath();
                ctx.moveTo(-player.w/2, -player.h/2);
                ctx.lineTo(player.w/2, player.h/2);
                ctx.moveTo(player.w/2, -player.h/2);
                ctx.lineTo(-player.w/2, player.h/2);
                ctx.strokeStyle = "white";
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            ctx.restore();
        }

        window.particles.forEach((p, i) => {
            p.x += p.dx; 
            p.y += p.dy; 
            p.life -= 0.02;
            ctx.fillStyle = p.c; 
            ctx.globalAlpha = p.life;
            ctx.fillRect(p.x, p.y, 4, 4);
            if(p.life <= 0) window.particles.splice(i, 1);
        });
        ctx.globalAlpha = 1.0;

        ctx.restore();

        if (window.gameState.includes('PLAY')) update(dt);
        requestAnimationFrame(draw);
    }

    function update(dt) {
        if(player.dead) return;

        // –ê–≤—Ç–æ–ø—Ä—ã–∂–æ–∫ –¥–ª—è –∫—É–±–∞
        if (isPressing && player.onG && player.mode === 'cube') {
            player.dy = jumpForce;
            player.onG = false;
        }

        // –ü–∞—É–∫
        if (player.mode === 'spider') {
            if (isPressing) {
                // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å (–±–ª–∏–∂–∞–π—à–∏–π –±–ª–æ–∫ –∏–ª–∏ –≥—Ä–∞–Ω–∏—Ü–∞)
                let bestDist = Infinity;
                let targetY = null;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –±–ª–æ–∫–∏, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å
                window.levelData.forEach(o => {
                    if (o.type === 'block' || o.type === 'halfblock' || o.type === 'slope') {
                        let s = o.scale || 1;
                        let blockTop = o.y;
                        let blockBottom = o.y + (o.type === 'halfblock' ? bs*s/2 : bs*s);
                        
                        // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≤–µ—Ä—Ö–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–ª–æ–∫–∞
                        let distToTop = Math.abs(player.y - (blockBottom + player.h));
                        if (distToTop < bestDist && blockBottom + player.h < player.y) {
                            bestDist = distToTop;
                            targetY = blockBottom;
                        }
                        // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –Ω–∏–∂–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±–ª–æ–∫–∞ (–ø–æ—Ç–æ–ª–æ–∫)
                        let distToBottom = Math.abs((player.y + player.h) - blockTop);
                        if (distToBottom < bestDist && blockTop > player.y + player.h) {
                            bestDist = distToBottom;
                            targetY = blockTop - player.h;
                        }
                    }
                });
                
                // –ï—Å–ª–∏ —Ä—è–¥–æ–º –Ω–µ—Ç –±–ª–æ–∫–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                if (targetY === null) {
                    if (player.y > logicalFloorY / 2) {
                        targetY = 0; // –ø–æ—Ç–æ–ª–æ–∫
                    } else {
                        targetY = logicalFloorY - player.h; // –ø–æ–ª
                    }
                }
                
                player.y = targetY;
                player.dy = 0;
            }
            
            player.x += speed * dt * 60;
            window.cameraX = player.x - 100;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –±–ª–æ–∫–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ–ª–∞/–ø–æ—Ç–æ–ª–∫–∞)
            let collides = false;
            window.levelData.forEach(o => {
                if (o.type === 'block' || o.type === 'halfblock' || o.type === 'spike' || o.type === 'slope') {
                    let s = o.scale || 1;
                    let oh = (o.type === 'halfblock') ? bs*s/2 : bs*s;
                    let oy = o.y;
                    if (o.type === 'halfblock') oy = o.y + bs*s/2;
                    
                    if (player.x < o.x + bs*s && player.x + player.w > o.x && 
                        player.y < oy + oh && player.y + player.h > oy) {
                        // –ù–µ —Å—á–∏—Ç–∞–µ–º –∑–∞ —Å–º–µ—Ä—Ç—å, –µ—Å–ª–∏ –ø–∞—É–∫ –ø—Ä–æ—Å—Ç–æ —Å—Ç–æ–∏—Ç –Ω–∞ –±–ª–æ–∫–µ —Å–≤–µ—Ä—Ö—É
                        if (!(player.y + player.h <= oy + 5 && player.dy >= 0)) {
                            collides = true;
                        }
                    }
                }
            });
            
            if (collides) die();
            
            document.getElementById('debug').innerText = `X: ${Math.floor(player.x)} Y: ${Math.floor(player.y)} MODE: ${player.mode}`;
            return;
        }

        // –§–∏–∑–∏–∫–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
        if (player.mode === 'cube') {
            player.w = bs; player.h = bs;
            player.dy += gravity * player.gravityMultiplier * dt * 60;
            player.y += player.dy * dt * 60;
        } else if (player.mode === 'wave') {
            player.w = 20; player.h = 20;
            player.dy = isPressing ? -waveSpeed : waveSpeed;
            player.y += player.dy * dt * 60;
        } else if (player.mode === 'ship') {
            player.w = 30; player.h = 20;
            if (isPressing) {
                player.dy += shipLift * dt * 60;
            } else {
                player.dy += shipGravity * dt * 60;
            }
            player.dy = Math.max(-8, Math.min(8, player.dy));
            player.y += player.dy * dt * 60;
        }

        player.x += speed * dt * 60; 
        window.cameraX = player.x - 100;

        if (player.y + player.h > logicalFloorY) { 
            if(player.mode === 'wave' || player.mode === 'ship') { 
                die(); 
            } else { 
                player.y = logicalFloorY - player.h; 
                player.dy = 0; 
                player.onG = true; 
            }
        }
        if (player.y < -200) die();

        window.levelData.forEach(o => {
            let s = o.scale || 1;
            let oh = bs*s;
            let oy = o.y;
            
            if (o.type === 'halfblock') {
                oh = bs*s/2;
                oy = o.y + bs*s/2;
            } else if (o.type.includes('portal')) {
                oh = bs*s*2;
                oy = o.y - bs*s;
            }
            
            let collision = false;
            
            if (player.mode === 'wave') {
                let lineY = player.y + player.h/2;
                if (player.x < o.x + bs*s && player.x + player.w > o.x && 
                    lineY > oy && lineY < oy + oh) {
                    collision = true;
                }
            } else {
                if (player.x < o.x + bs*s && player.x + player.w > o.x && 
                    player.y < oy + oh && player.y + player.h > oy) {
                    collision = true;
                }
            }
            
            if (collision) {
                if (o.type === 'block' || o.type === 'halfblock') {
                    if (player.mode === 'cube' && player.dy > 0 && player.y + player.h < oy + 15) {
                        player.y = oy - player.h; 
                        player.dy = 0; 
                        player.onG = true;
                    } else { 
                        die(); 
                    }
                } else if (o.type === 'slope') {
                    if (player.mode === 'cube') {
                        let relX = (player.x + player.w/2) - o.x;
                        if (relX >= 0 && relX <= bs*s) {
                            let slopeY = o.y + bs*s - relX;
                            if (player.y + player.h > slopeY && player.y < o.y + bs*s) {
                                if (player.dy > 0) {
                                    player.y = slopeY - player.h;
                                    player.dy = 0;
                                    player.onG = true;
                                } else {
                                    die();
                                }
                            }
                        }
                    } else {
                        die();
                    }
                } else if (o.type === 'spike') {
                    die();
                } else if (o.type === 'end') { 
                    alert("LEVEL COMPLETE!"); 
                    window.togglePlaytest(); 
                }
                // –û—Ä–±—ã
                else if (o.type === 'orb' && isPressing && player.mode === 'cube') { 
                    player.dy = jumpForce * player.gravityMultiplier; 
                    player.onG = false; 
                }
                else if (o.type === 'orb_pink' && isPressing && player.mode === 'cube') { 
                    player.dy = jumpForce * orbPinkFactor * player.gravityMultiplier; 
                    player.onG = false; 
                }
                else if (o.type === 'orb_red' && isPressing && player.mode === 'cube') { 
                    player.dy = jumpForce * orbRedFactor * player.gravityMultiplier; 
                    player.onG = false; 
                }
                else if (o.type === 'orb_black' && player.mode === 'cube') { 
                    player.gravityMultiplier *= -1;
                    player.onG = false;
                }
                // –ü–∞–¥—ã
                else if (o.type === 'pad' && player.mode === 'cube') { 
                    player.dy = jumpForce * padFactor * player.gravityMultiplier; 
                    player.onG = false; 
                }
                else if (o.type === 'pad_pink' && player.mode === 'cube') { 
                    player.dy = jumpForce * padPinkFactor * player.gravityMultiplier; 
                    player.onG = false; 
                }
                else if (o.type === 'pad_red' && player.mode === 'cube') { 
                    player.dy = jumpForce * padRedFactor * player.gravityMultiplier; 
                    player.onG = false; 
                }
                // –ü–æ—Ä—Ç–∞–ª
                else if (o.type === 'portal_wave') player.mode = 'wave';
                else if (o.type === 'portal_cube') {
                    player.mode = 'cube';
                    player.gravityMultiplier = 1;
                }
                else if (o.type === 'portal_ship') player.mode = 'ship';
                else if (o.type === 'portal_spider') player.mode = 'spider';
            }
        });

        document.getElementById('debug').innerText = `X: ${Math.floor(player.x)} Y: ${Math.floor(player.y)} MODE: ${player.mode}`;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const actionDown = (e) => {
        if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
        if (e.type === 'keydown' && !['Space','ArrowUp','KeyW'].includes(e.code)) return;
        e.preventDefault();
        isPressing = true;
    };

    const actionUp = (e) => {
        if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
        if (e.type === 'keyup' && !['Space','ArrowUp','KeyW'].includes(e.code)) return;
        isPressing = false;
    };
    
    window.addEventListener('mousedown', actionDown);
    window.addEventListener('touchstart', actionDown);
    window.addEventListener('keydown', actionDown);
    window.addEventListener('mouseup', actionUp);
    window.addEventListener('touchend', actionUp);
    window.addEventListener('keyup', actionUp);

    requestAnimationFrame(draw);
</script>
</body>
</html>