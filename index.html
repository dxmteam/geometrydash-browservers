<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GD_REDACTED_V4_FULL_ONLINE</title>
    <style>
        :root { --neon: #00ff41; --bg: #050505; --panel: #111; --text: #eee; --gold: #ffd700; }
        body { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: var(--text); touch-action: none; }
        canvas { display: block; }

        /* ЭКРАНЫ */
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #111 0%, #000 100%); z-index: 100; }
        .hidden { display: none !important; }
        
        .menu-card { background: var(--panel); padding: 30px; border: 1px solid #333; box-shadow: 0 0 30px rgba(0,255,65,0.1); text-align: center; border-radius: 4px; width: 340px; }
        h1 { color: var(--neon); text-shadow: 0 0 10px var(--neon); letter-spacing: 4px; font-size: 24px; margin-bottom: 20px; }
        
        input { background: #000; border: 1px solid #333; color: var(--neon); padding: 12px; width: 100%; margin: 10px 0; box-sizing: border-box; outline: none; }
        
        .btn { background: transparent; color: var(--neon); border: 1px solid var(--neon); padding: 12px; margin: 5px; width: 100%; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; box-sizing: border-box; }
        .btn:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
        .btn-red { color: #ff3e3e; border-color: #ff3e3e; }
        .btn-red:hover { background: #ff3e3e; box-shadow: 0 0 15px #ff3e3e; }
        .btn-gold { color: var(--gold); border-color: var(--gold); }

        /* ИНТЕРФЕЙС ИГРЫ/РЕДАКТОРА */
        #top-bar { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 10px; box-sizing: border-box; z-index: 60; background: rgba(0,0,0,0.8); }
        .level-tag { color: var(--neon); font-size: 12px; align-self: center; font-weight: bold; }

        #editor-ui { position: absolute; bottom: 0; left: 0; width: 100%; height: 160px; background: #000; border-top: 1px solid #333; display: flex; flex-direction: column; z-index: 50; }
        .tabs { display: flex; background: #0a0a0a; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; opacity: 0.4; font-size: 14px; }
        .tab.active { opacity: 1; color: var(--neon); border-bottom: 2px solid var(--neon); }
        
        .content-area { display: flex; overflow-x: auto; padding: 15px; gap: 12px; height: 100%; align-items: center; }
        .obj-btn { min-width: 65px; height: 65px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; cursor: pointer; background: #111; flex-shrink: 0; }
        
        .list-container { margin-top: 15px; width: 100%; max-height: 250px; overflow-y: auto; }
        .level-item { background: #0d0d0d; padding: 12px; margin: 8px 0; border: 1px solid #222; text-align: left; position: relative; }
        .rated-dot { color: var(--gold); text-shadow: 0 0 8px var(--gold); margin-right: 5px; font-size: 18px; vertical-align: middle; }
        .stars-label { color: var(--gold); font-size: 10px; display: block; margin-top: 4px; font-weight: bold; }
        
        .admin-box { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444; display: flex; gap: 5px; }
    </style>
</head>
<body>

<div id="screen-auth" class="screen">
    <div class="menu-card">
        <h1>CONNECT_NET</h1>
        <input type="text" id="auth-nick" placeholder="NICKNAME (requst on every restart)">
        <button class="btn" onclick="window.authUser()">LOGIN</button>
    </div>
</div>

<div id="main-menu" class="screen hidden">
    <div class="menu-card">
        <h1 id="welcome-text">GD_REDACTED</h1>
        <button class="btn" onclick="window.startNewLevel()">EDITOR</button>
        <button class="btn" onclick="window.showScreen('my-levels')">MY LEVELS</button>
        <button class="btn" onclick="window.showScreen('online-levels')">GLOBAL SERVER</button>
        <button class="btn btn-red" onclick="location.reload()">LOGOUT</button>
    </div>
</div>

<div id="my-levels" class="screen hidden">
    <div class="menu-card" style="width: 380px;">
        <h1>LOCAL_STORAGE</h1>
        <div id="levels-list" class="list-container"></div>
        <button class="btn btn-red" onclick="window.showScreen('main-menu')">BACK</button>
    </div>
</div>

<div id="online-levels" class="screen hidden">
    <div class="menu-card" style="width: 420px;">
        <h1>GLOBAL_NET</h1>
        <div id="online-list" class="list-container"></div>
        <button class="btn btn-red" onclick="window.showScreen('main-menu')">BACK</button>
    </div>
</div>

<div id="top-bar" class="hidden">
    <button class="btn" style="width:auto" id="exit-btn" onclick="window.exitToMenu()">EXIT</button>
    <div id="level-info" class="level-tag">ID: 0000 | MODE: BUILD</div>
    <button class="btn" id="play-btn" style="width:auto" onclick="window.togglePlaytest()">PLAY</button>
</div>

<div id="editor-ui" class="hidden">
    <div class="tabs">
        <div id="tab-build" class="tab active" onclick="window.switchTab('build')">BUILD</div>
        <div id="tab-edit" class="tab" onclick="window.switchTab('edit')">EDIT</div>
    </div>
    
    <div id="panel-build" class="content-area">
        <div class="obj-btn" onclick="window.selectedType='block'">BLOCK</div>
        <div class="obj-btn" onclick="window.selectedType='spike'">SPIKE</div>
        <div class="obj-btn" onclick="window.selectedType='start'" style="color:cyan">START</div>
        <div class="obj-btn" onclick="window.selectedType='orb'" style="color:yellow">ORB</div>
        <div class="obj-btn" onclick="window.selectedType='pad'" style="color:magenta">PAD</div>
        <div class="obj-btn" onclick="window.selectedType='end'" style="color:var(--neon)">FINISH</div>
    </div>
    
    <div id="panel-edit" class="content-area hidden">
        <button class="btn" style="width:50px" onclick="window.cameraX -= 150"> << </button>
        <button class="btn" style="width:50px" onclick="window.cameraX += 150"> >> </button>
        <button class="btn" style="width:50px" onclick="window.moveObj(0,-10)">UP</button>
        <button class="btn" style="width:50px" onclick="window.moveObj(0,10)">DN</button>
        <button class="btn" style="width:60px" onclick="window.rotateObj()">ROT</button>
        <button class="btn btn-red" style="width:60px" onclick="window.deleteObj()">DEL</button>
    </div>
</div>

<canvas id="g"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove, update as dbUpdate } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB2cAHCuBmB7rr0S9YFmAQ3fK9lvUm-8AQ",
        authDomain: "dfssdfgg-df720.firebaseapp.com",
        projectId: "dfssdfgg-df720",
        storageBucket: "dfssdfgg-df720.firebasestorage.app",
        messagingSenderId: "751965793703",
        appId: "1:751965793703:web:9dcfbf89ca9997b757da82",
        databaseURL: "https://dfssdfgg-df720-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ГЛОБАЛЬНОЕ СОСТОЯНИЕ
    window.user = { nick: "", isAdmin: false };
    window.gameState = 'AUTH';
    window.currentTab = 'build';
    window.selectedType = 'block';
    window.selectedInstance = null;
    window.levelData = [];
    window.cameraX = 0;
    window.curName = "Project";
    window.curId = 0;

    const cvs = document.getElementById('g');
    const ctx = cvs.getContext('2d');
    cvs.width = window.innerWidth;
    cvs.height = window.innerHeight;

    const bs = 40; 
    const gravity = 0.12;
    const jumpForce = -4.8;
    const speed = 2.4;
    const floorY = cvs.height * 0.7;

    let player = { x: 100, y: floorY - bs, w: bs, h: bs, dy: 0, onG: false };
    let isPressing = false;

    // --- СИСТЕМА АККАУНТОВ ---
    window.authUser = function() {
        const nick = document.getElementById('auth-nick').value.trim();
        if(!nick) return alert("ENTER NAME");
        window.user.nick = nick;
        window.user.isAdmin = (nick === "dxmtm");
        document.getElementById('welcome-text').innerText = "PLAYER: " + nick;
        window.showScreen('main-menu');
    };

    // --- FIREBASE ФУНКЦИИ ---
    window.publishLevel = async function(id) {
        let levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        let lvl = levels.find(l => l.id === id);
        if (lvl) {
            lvl.author = window.user.nick;
            lvl.stars = 0;
            try {
                await set(ref(db, 'public_levels/' + id), lvl);
                alert("PUBLISHED TO CLOUD!");
                window.renderLevelsList();
            } catch(e) { alert("DB ERROR: Check rules!"); }
        }
    };

    window.loadOnlineLevels = async function() {
        const list = document.getElementById('online-list');
        list.innerHTML = "SYNCING...";
        try {
            const snap = await get(child(ref(db), 'public_levels'));
            if (snap.exists()) {
                const data = snap.val();
                list.innerHTML = Object.values(data).map(l => `
                    <div class="level-item">
                        <div>
                            ${l.stars > 0 ? '<span class="rated-dot">●</span>' : ''}
                            <b style="color:var(--neon)">${l.name}</b> 
                            <span style="font-size:9px; opacity:0.6">by ${l.author || 'Guest'}</span>
                            ${l.stars > 0 ? `<span class="stars-label">${l.stars} STARS</span>` : ''}
                        </div>
                        <button class="btn" style="width:70px; font-size:10px; padding:5px; margin-top:5px;" 
                                onclick="window.playGlobalLevel('${btoa(JSON.stringify(l))}')">PLAY</button>
                        
                        ${window.user.isAdmin ? `
                            <div class="admin-box">
                                <button class="btn btn-red" style="font-size:9px; padding:2px" onclick="window.adminDelete(${l.id})">DEL</button>
                                <button class="btn btn-gold" style="font-size:9px; padding:2px" onclick="window.adminRate(${l.id})">RATE</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else { list.innerText = "SERVER EMPTY"; }
        } catch(e) { list.innerText = "NET ERROR"; }
    };

    window.adminDelete = async function(id) {
        if(confirm("DELETE FROM CLOUD?")) {
            await remove(ref(db, 'public_levels/' + id));
            window.loadOnlineLevels();
        }
    };

    window.adminRate = async function(id) {
        const s = prompt("STARS (1-10):");
        if(s) {
            await dbUpdate(ref(db, 'public_levels/' + id), { stars: parseInt(s) });
            window.loadOnlineLevels();
        }
    };

    // --- ЛОГИКА ИНТЕРФЕЙСА ---
    window.showScreen = function(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        if(id !== 'none') document.getElementById(id).classList.remove('hidden');
        if(id === 'my-levels') window.renderLevelsList();
        if(id === 'online-levels') window.loadOnlineLevels();
    };

    window.startNewLevel = function() {
        window.levelData = [];
        window.curName = prompt("NAME:") || "LEVEL";
        window.curId = Math.floor(Math.random() * 8999) + 1000;
        window.gameState = 'EDITOR';
        window.toggleUI(true);
    };

    window.toggleUI = function(show) {
        document.getElementById('editor-ui').classList.toggle('hidden', !show);
        document.getElementById('top-bar').classList.toggle('hidden', !show);
        document.getElementById('main-menu').classList.toggle('hidden', show);
        document.getElementById('level-info').innerText = `ID: ${window.curId} | ${window.curName}`;
        document.getElementById('exit-btn').innerText = show ? "SAVE & EXIT" : "EXIT";
    };

    window.switchTab = function(t) {
        window.currentTab = t;
        document.getElementById('tab-build').classList.toggle('active', t === 'build');
        document.getElementById('tab-edit').classList.toggle('active', t === 'edit');
        document.getElementById('panel-build').classList.toggle('hidden', t !== 'build');
        document.getElementById('panel-edit').classList.toggle('hidden', t !== 'edit');
    };

    // --- ЯДРО ИГРЫ ---
    window.playGlobalLevel = function(b64) {
        const lvl = JSON.parse(atob(b64));
        window.levelData = lvl.data;
        window.curId = lvl.id;
        window.curName = lvl.name;
        window.gameState = 'ONLINE_PLAY';
        
        window.showScreen('none');
        document.getElementById('top-bar').classList.remove('hidden');
        document.getElementById('editor-ui').classList.add('hidden');
        document.getElementById('play-btn').innerText = "PAUSE";
        document.getElementById('level-info').innerText = `${window.curName} by ${lvl.author}`;
        resetPlayer();
    };

    window.togglePlaytest = function() {
        if (window.gameState === 'EDITOR') {
            window.gameState = 'PLAYTEST';
            resetPlayer();
            document.getElementById('play-btn').innerText = 'STOP';
        } else if (window.gameState === 'PLAYTEST') {
            window.gameState = 'EDITOR';
            document.getElementById('play-btn').innerText = 'PLAY';
        } else if (window.gameState === 'ONLINE_PLAY') {
            if(confirm("EXIT LEVEL? You will need to access your account")) window.exitToMenu();
        }
    };

    function resetPlayer() {
        const start = window.levelData.find(o => o.type === 'start');
        player.x = start ? start.x : 100;
        player.y = start ? start.y : floorY - bs;
        player.dy = 0; window.cameraX = player.x - 100;
    }

    window.exitToMenu = function() {
        if(window.gameState === 'EDITOR' || window.gameState === 'PLAYTEST') {
            window.saveLocal();
        }
        location.reload();
    };

    window.saveLocal = function() {
        let levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        levels = levels.filter(l => l.id !== window.curId);
        levels.push({ id: window.curId, name: window.curName, data: window.levelData, author: window.user.nick });
        localStorage.setItem('gd_v3', JSON.stringify(levels));
    };

    window.renderLevelsList = function() {
        const list = document.getElementById('levels-list');
        const levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        list.innerHTML = levels.map(l => `
            <div class="level-item">
                <span>#${l.id} <b>${l.name}</b></span>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn" style="width:auto; padding:5px" onclick="window.loadLocalLevel(${l.id})">EDIT</button>
                    <button class="btn" style="width:auto; padding:5px; color:cyan" onclick="window.publishLevel(${l.id})">PUB</button>
                </div>
            </div>
        `).join('');
    };

    window.loadLocalLevel = function(id) {
        const levels = JSON.parse(localStorage.getItem('gd_v3') || '[]');
        const lvl = levels.find(l => l.id === id);
        window.levelData = lvl.data; window.curId = lvl.id; window.curName = lvl.name;
        window.gameState = 'EDITOR'; 
        window.toggleUI(true);
        window.showScreen('none');
    };

    // РЕДАКТИРОВАНИЕ
    cvs.addEventListener('mousedown', e => {
        if (window.gameState !== 'EDITOR' || e.clientY > cvs.height - 160) return;
        const x = e.clientX + window.cameraX;
        const y = e.clientY;
        if (window.currentTab === 'build') {
            window.levelData.push({ x: Math.floor(x/bs)*bs, y: Math.floor(y/bs)*bs, type: window.selectedType, rot: 0 });
        } else {
            window.selectedInstance = window.levelData.find(o => x > o.x && x < o.x + bs && y > o.y && y < o.y + bs);
        }
    });

    window.moveObj = (dx, dy) => { if(window.selectedInstance) { window.selectedInstance.x += dx; window.selectedInstance.y += dy; } };
    window.rotateObj = () => { if(window.selectedInstance) window.selectedInstance.rot = (window.selectedInstance.rot + 90) % 360; };
    window.deleteObj = () => { if(window.selectedInstance) { window.levelData = window.levelData.filter(o => o !== window.selectedInstance); window.selectedInstance = null; } };

    // ЦИКЛ ОТРИСОВКИ
    function draw() {
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, cvs.width, cvs.height);
        ctx.strokeStyle = "#111";
        for (let i = 0; i < cvs.width + bs; i += bs) {
            ctx.beginPath(); ctx.moveTo(i - (window.cameraX % bs), 0); ctx.lineTo(i - (window.cameraX % bs), cvs.height); ctx.stroke();
        }

        ctx.save(); ctx.translate(-window.cameraX, 0);
        ctx.strokeStyle = "#222"; ctx.strokeRect(-window.cameraX, floorY, cvs.width + window.cameraX + 10000, 1);

        window.levelData.forEach(o => {
            ctx.save(); ctx.translate(o.x + bs/2, o.y + bs/2); ctx.rotate(o.rot * Math.PI / 180);
            if (o === window.selectedInstance && window.currentTab === 'edit') {
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.strokeRect(-bs/2, -bs/2, bs, bs);
            }
            if (o.type === 'spike') {
                ctx.fillStyle = "#eee"; ctx.beginPath(); ctx.moveTo(-bs/2, bs/2); ctx.lineTo(0, -bs/2); ctx.lineTo(bs/2, bs/2); ctx.fill();
            } else if (o.type === 'start') {
                ctx.strokeStyle = "cyan"; ctx.strokeRect(-bs/2, -bs/2, bs, bs);
            } else if (o.type === 'orb') {
                ctx.strokeStyle = "yellow"; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.stroke();
            } else if (o.type === 'pad') {
                ctx.fillStyle = "magenta"; ctx.fillRect(-bs/2, bs/4, bs, bs/4);
            } else {
                ctx.fillStyle = o.type === 'end' ? "#00ff41" : "#333";
                ctx.fillRect(-bs/2, -bs/2, bs, bs);
                ctx.strokeStyle = "#444"; ctx.strokeRect(-bs/2, -bs/2, bs, bs);
            }
            ctx.restore();
        });

        if (window.gameState !== 'AUTH' && window.gameState !== 'MENU') {
            ctx.fillStyle = "#00ff41";
            ctx.fillRect(player.x, player.y, player.w, player.h);
            ctx.strokeStyle = "white"; ctx.strokeRect(player.x, player.y, player.w, player.h);
        }
        ctx.restore();

        if (window.gameState.includes('PLAY')) update();
        requestAnimationFrame(draw);
    }

    function update() {
        player.dy += gravity; player.y += player.dy;
        player.x += speed; window.cameraX = player.x - 100;

        if (player.y + player.h > floorY) { player.y = floorY - player.h; player.dy = 0; player.onG = true; }

        window.levelData.forEach(o => {
            if (player.x < o.x + bs && player.x + player.w > o.x && player.y < o.y + bs && player.y + player.h > o.y) {
                if (o.type === 'block') {
                    if (player.dy > 0 && player.y + player.h < o.y + 15) {
                        player.y = o.y - player.h; player.dy = 0; player.onG = true;
                    } else { resetPlayer(); }
                }
                if (o.type === 'spike') resetPlayer();
                if (o.type === 'end') { alert("LEVEL COMPLETE!"); window.togglePlaytest(); }
                if (o.type === 'orb' && isPressing) { player.dy = jumpForce; player.onG = false; }
                if (o.type === 'pad') { player.dy = jumpForce * 1.6; player.onG = false; }
            }
        });
    }

    const action = () => { 
        if(window.gameState.includes('PLAY') && player.onG) { player.dy = jumpForce; player.onG = false; } 
        isPressing = true;
    };
    window.addEventListener('mousedown', action);
    window.addEventListener('touchstart', action);
    window.addEventListener('mouseup', () => isPressing = false);
    window.addEventListener('touchend', () => isPressing = false);

    draw();
</script>
</body>
</html>
